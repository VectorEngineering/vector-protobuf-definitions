import { Hono } from "hono";
import { cors } from "hono/cors";
import { {{basename openApiSpec.info.title}}Router } from "./routes";
import type { Env } from "./types";
import type { MiddlewareHandler } from "hono";

// Import user-defined middleware
import * as middleware from "./middleware";

const app = new Hono<{
  Bindings: Env;
}>();

// CORS middleware
app.use("*", cors({
  origin: "*",
  allowMethods: [{{#each openApiSpec.paths}}{{#with this}}{{#if get}}"GET",{{/if}}{{#if post}}"POST",{{/if}}{{#if put}}"PUT",{{/if}}{{#if delete}}"DELETE",{{/if}}{{/with}}{{/each}}"OPTIONS"],
  allowHeaders: ["Content-Type", "Authorization"],
  exposeHeaders: ["Content-Length", "X-Request-Id"],
  maxAge: 86400,
}));

// Apply user-defined middleware
Object.values(middleware).forEach(mw => {
  if (typeof mw === 'function') {
    app.use("*", mw as MiddlewareHandler<{ Bindings: Env }>);
  }
});

// API routes
app.route("/api", {{basename openApiSpec.info.title}}Router);

export default app; 